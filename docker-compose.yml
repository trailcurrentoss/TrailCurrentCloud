name: trailcurrent-cloud

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    volumes:
      - ./data/keys/server.crt:/etc/nginx/certs/server.crt:ro
      - ./data/keys/server.key:/etc/nginx/certs/server.key:ro
      - certbot-webroot:/var/www/certbot:ro
    ports:
      - "${FRONTEND_HTTP_PORT:-80}:80"
      - "${FRONTEND_PORT:-8443}:443"
    restart: unless-stopped
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - MONGODB_URI=mongodb://mongodb:27017/trailcurrent
      - API_PORT=3000
      - MQTT_BROKER_URL=mqtts://mosquitto:8883
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - TLS_CERT_HOSTNAME=${TLS_CERT_HOSTNAME}
      - DEPLOYMENT_STORAGE_PATH=/data/deployments
    volumes:
      - ./data/keys/ca.pem:/app/certs/ca.pem:ro
      - ./data/deployments:/data/deployments
    restart: unless-stopped
    depends_on:
      - mosquitto
      - mongodb
      - tileserver

  mongodb:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db

  mosquitto:
    build:
      context: ./mosquitto
      dockerfile: Dockerfile
    environment:
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
    volumes:
      - ./data/keys/server.crt:/mosquitto/host-certs/server.crt:ro
      - ./data/keys/server.key:/mosquitto/host-certs/server.key:ro
      - ./data/keys/ca.crt:/mosquitto/host-certs/ca.crt:ro
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    ports:
      - "${MQTT_PORT:-8883}:8883"
    hostname: mosquitto
    restart: always

  tileserver:
    image: trailcurrent/trailcurrent-tile-server:latest
    volumes:
      - ./data/tileserver:/data/tiles:ro
      - ./tileserver/styles:/data/styles:ro
      - ./tileserver/config.json:/config.json:ro
    ports:
      - "${TILESERVER_PORT:-8080}:80"
    healthcheck:
      test: ["CMD-SHELL", "node /usr/src/app/src/healthcheck.js"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

volumes:
  mongodb-data:
  certbot-webroot:
